---
title: "Barnacles TURFs Vulnerability assessment"
author: "Raquel Ruiz-Díaz"
date: "17/04/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This document shows the script developed for the study "Socio-ecological vulnerability to climate change in small-scale fisheries under spatial property rights". 

## Libraries:
we need to install some packages and libraries to be able to run the script

```{r libraries}
library(ggrepel)
library(readr)
library(tidyverse)
library(corrplot)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## Normalization functions
This function is created to normalize values from 0 to 1.

```{}
normalize_positive <-function(x) {
  (x - min(x,na.rm = TRUE))/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

normalize_negative <-function(x) {
  (max(x,na.rm = TRUE)-x)/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}
```
# **ECOLOGICAL VULNERABILITY**
## 1. Normalization of indicators:
In this first step we need to normalized our indicators in order to make them comparables. We start by normalizing indicators that build the ecological vulnerability and then we do the same for those of social vulnerability.

### 1.1 Ecological indicator's normalization:
#### 1.1.a Ecological Exposure

##### i. Import dataset
```{}
Ecological_exposure <- read.csv("data/Ecological_exposure.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)
```{}
exposure<- Ecological_exposure %>% 
  select(fishing.guild, Text)%>% 
  distinct%>%
  mutate (TextN=normalize_positive(Text))

exposure.N<- exposure [, c(1, 3)]
```

##### iii. Save generated dataframe

```{}
write.table(exposure.N, file="generated_dataframes/eco.factor_exp.csv", sep = ";" )
factor.eco.exp <- read.csv("generated_dataframes/eco.factor_exp.csv", sep = ";" )
```

#### 1.1.b Ecological Sensitivity

##### i. Import dataset

```{}
Ecological_sensitivity <- read.csv("data/Ecological_sensitivity.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)

```{}
sensitivity<- Ecological_sensitivity %>% 
  select(fishing.guild, ABUND, HARV, EXPLOT)%>% 
  distinct%>%
  mutate (ABUNDN=normalize_positive(ABUND),
          HARVN=normalize_positive(HARV),
          EXPLOTN=normalize_positive(EXPLOT))

sensitivity.N<- sensitivity [, c(1, 5, 6, 7)]
```

##### iii. Save generated dataframe

```{}
write.table(sensitivity.N, file="generated_dataframes/Boat_eco.factor_sen.csv", sep = ";" )
factor.eco.sen <- read.csv("generated_dataframes/Boat_eco.factor_sen.csv", sep = ";" )
```

#### 1.1.c Recovery Potential

##### i. Import dataset

```{}
Ecological_recoverypot <- read.csv("data/Ecological_recoverypot.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)

```{}
recovery.pot<- Ecological_recoverypot %>% 
  select(fishing.guild, bank.length, Clo)%>% 
  distinct%>%
  mutate (bank.lengthN=normalize_positive(bank.length),
          CloN=normalize_positive(Clo))
        
recovery.potN<- recovery.pot [, c(1, 4,5)]
```

##### iii. Save generated dataframe

```{}
write.table(recovery.potN, file="generated_dataframes/eco.factor_reco.csv", sep = ";" )
factor.eco.reco <- read.csv("generated_dataframes/eco.factor_reco.csv", sep = ";" )
```

### Pearson Correlation analysis 
#### i. Merge databases by fishing guild
```{}
f<- merge(exposure.N, sensitivity.N, by="fishing.guild")
f2<- merge(f, recovery.potN, by="fishing.guild")
f3<-  f2 [, c(2:6)]
```

#### ii. Correlation plot

```{}
#open the jpeg device
jpeg(file="figures/Ecological_correlation_plot.jpeg", height=6, width= 9, units="in", res=300)
#fill the pdf
finalcor<- cor(f3, method= "pearson", use = "pairwise.complete.obs")
corrplot(finalcor, order ="FPC", tl.col = "black", type = "lower")
#close the pdf
dev.off()
```


## 2. Building Factors
Remember that some indicators are combined to build factors which are used in the final index.

### 2.1
#### 2.1.a. Ecological exposure

```{}
exposure.N
factor1=transform(exposure.N,CLIME= TextN)
EXPOSURE.eco= factor1 [, c(1, 3)]
expo=transform(EXPOSURE.eco, EXPOSURE= CLIME)
EXPOSURE= expo[, c(1,3)]
```

#### 2.1.b. Ecological sensitivity

```{}
sensitivity.N
factor2=transform(sensitivity.N,QUANTITY_CHANGE= (ABUNDN+HARVN+EXPLOTN)/3)
factor2
SENSITIVITY.eco= factor2 [, c(1, 5)]
sens=transform(SENSITIVITY.eco, SENSITIVITY= QUANTITY_CHANGE)
SENSITIVITY= sens [, c(1,3)]

## Normalization
SN<- SENSITIVITY %>% 
  select(fishing.guild, SENSITIVITY)%>% 
  distinct%>%
  mutate (SENSITIVITYN=normalize_positive(SENSITIVITY))
        
SENSITIVITY<- SN [, c(1, 3)]
```

#### 2.1.c. Recovery potential

```{}
recovery.potN
factor3= transform(recovery.potN, HABITAT=bank.lengthN)
factor4= transform(factor3, CLOSURES=CloN)
RECOVERY.POT.factors=factor4 [, c(1, 4,5)]
RECOVERY.POTENL= transform(RECOVERY.POT.factors, RECOVERY.POT=(HABITAT+CLOSURES)/2)
RECOVERY.POTENCIAL=RECOVERY.POTENL [, c(1, 4)]

## Normalization
RPN<- RECOVERY.POTENCIAL %>% 
  select(fishing.guild, RECOVERY.POT)%>% 
  distinct%>%
  mutate (RECOVERY.POTN2=normalize_positive(RECOVERY.POT))
        
RECOVERY.POTENCIAL<- RPN [, c(1, 3)]

```

## 3. Building Ecological Vulnerability dimension
### 3.a Merging and generating new database

```{}
Dimension.matrix1<- merge(EXPOSURE, SENSITIVITY, by="fishing.guild")
Dimension.matrix2<- merge(Dimension.matrix1, RECOVERY.POTENCIAL, by="fishing.guild")

#Creating a new dataframe
write.table(Dimension.matrix2, file="generated_dataframes/1704Ecological_dimension.matrix.csv", sep = ";" )
````

### 3.b Import new database and calculate the dimension

```{}
Ecological.dim <- read.csv("generated_dataframes/1704Ecological_dimension.matrix.csv", sep = ";" )
Ecological.dim

#ECOLOGICAL VULNERABILITY SCORE
Eco.vul= transform(Ecological.dim, ECOLOGICAL.VUL=(EXPOSURE+SENSITIVITYN)-RECOVERY.POTN2)

# Create a dataset with the final score
write.table(Eco.vul, file="generated_dataframes/Ecological_vulnerability2.csv", sep = ";" )
```

### 3.c Plot Ecological_vulnerability
```{}
#Create a categorical variable for exposure ("low","middle","high").

res <- Eco.vul %>% mutate(Exposure=cut(EXPOSURE, breaks=c(-Inf, 0.333, 0.666, Inf), labels=c("low","middle","high")))

## Normalization
RES<- res %>% 
  select(fishing.guild, EXPOSURE, SENSITIVITYN, RECOVERY.POTN2, ECOLOGICAL.VUL, Exposure)%>% 
  distinct%>%
  mutate (ECOLOGICAL.VULN=normalize_positive(ECOLOGICAL.VUL))


#Making the Plot
jpeg(file="figures/1704Ecological.vul.jpeg", height=6, width= 8, units="in", res=300)
ggplot(RES, aes(x=RECOVERY.POTN2, y=SENSITIVITYN, size= Exposure, color=ECOLOGICAL.VULN))+
  geom_point(alpha=0.3) +
  labs(x= "Recovery Potential", y= "Sensitivity", color="Ecological 
Vulnerability", size= "Exposure")+
  xlim(-0.1, 1) +
  scale_size_discrete(range = c(4, 8))+
  scale_colour_gradient2 (low="green", mid = "orange", high="red", midpoint = 0.5) +
  geom_text_repel(aes(label =fishing.guild), size= 4.5) +
  theme_minimal(base_size = 13)
dev.off()

```






# **SOCIOECOLOGICAL VULNERABILITY**
## 1. Normalization of indicators:
### 1.2. Socioeconomic indicator's normalization: 
#### 1.2.a Ecological_vulnerability: 

##### i. Import dataset

```{}
ecological_vulnerability <- read.csv("generated_dataframes/Ecological_vulnerability2.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)

```{}
Eco.Vul<- ecological_vulnerability %>% 
  select(fishing.guild, ECOLOGICAL.VUL )%>% 
  distinct%>%
  mutate (ECOLOGICAL.VULN=normalize_positive(ECOLOGICAL.VUL))

Eco.Vul.N<- RES [, c(1, 7)]
```


#### 1.2.b Social Sensitivity

##### i. Import dataset

```{}
Socioeco_sensitivity <- read.csv("Data/Socioeco_sensitivity.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)

```{}
sensitivity.SE<- Socioeco_sensitivity %>% 
  select(fishing.guild, FISHERY.DEPENDENCY, Relative_fishers, fishing.effort, POUCH, ISO, Modality)%>% 
  distinct%>%
  mutate (Relative_fishersN=normalize_positive(Relative_fishers),
          FISHERY.DEPENDENCYN=normalize_positive(FISHERY.DEPENDENCY),
          fishing.effortN=normalize_positive(fishing.effort),
          POUCHN=normalize_positive(POUCH),
          ISON=normalize_positive(ISO),
          Modality=Modality)

sensitivity.SE.N<- sensitivity.SE [, c(1, 7:12)]
```


#### 1.2.c Adaptive Capacity

##### i. Import dataset

```{}
Socioeco_adaptivecap <- read.csv("Data/Socioeco_adaptivecap.csv", sep = ";" )
```

##### ii. use functions to normalize (Normalization positive)

```{}
adapt.cap<- Socioeco_adaptivecap %>% 
  select(fishing.guild, FISHERS.WELL, MARKET, ROTATION, TA, Price, ADAPT.MNGMT)%>% 
  distinct%>%
  mutate (FISHERS.WELLN=normalize_positive(FISHERS.WELL),
          MARKETN=normalize_positive(MARKET),
          ROTATION.N=normalize_positive(ROTATION),
          TA.N=normalize_positive(TA))

adapt.cap.N<- adapt.cap [, c(1, 6:11)]
```

### Pearson Correlation analysis 
#### i. Merge databases by fishing guild
```{}
f<- merge(Eco.Vul.N, sensitivity.SE.N, by="fishing.guild")
f2<- merge(f, adapt.cap.N, by="fishing.guild")
f3<-  f2 [, c(2, 4:8, 10:13)]
```

#### ii. Correlation plot

```{}
#open the jpeg device
jpeg(file="figures/Sociocological_correlation_plot.jpeg", height=6, width= 9, units="in", res=300)
#fill the pdf
finalcor<- cor(f3, method= "pearson", use = "pairwise.complete.obs")
corrplot(finalcor, order ="FPC", tl.col = "black", type = "lower")
#close the pdf
dev.off()
```

## 2. Building Factors
Remember that some indicators are combined to build factors which are used in the final index.

### 2.2 Socio-economic factors
#### 2.2.a. Ecological vulnerability

```{}
EV<- Eco.Vul.N
```

#### 2.2.b. Social sensitivity

```{}
sensitivity.SE.N
factor5=transform(sensitivity.SE.N, WORK_OPE= fishing.effortN)
factor6= transform(factor5, EMPLOY_DIF= ISON)
factor7=transform(factor6, POUCH= POUCHN)
factor8=transform(factor7, FISHING_DEPENDENCY= (Relative_fishersN +FISHERY.DEPENDENCYN)/2)
factor9=transform(factor8, Modality= Modality)


SENSITIVITY.factors= factor9 [, c(1:2, 8:11)]

SENSITIVITY.factors
SENSITIVITY.1= transform(SENSITIVITY.factors, SENSITIVITY= (POUCH+FISHING_DEPENDENCY+WORK_OPE+EMPLOY_DIF)/4)

SS<- SENSITIVITY.1[, c(1,2,7)]

## Normalization
SSN<- SS %>% 
  select(fishing.guild, Modality, SENSITIVITY)%>% 
  distinct%>%
  mutate (SENSITIVITYN=normalize_positive(SENSITIVITY))
        
SS<- SSN [, c(1, 2,4)]



```

#### 2.2.c. Adaptive Capacity

```{}
adapt.cap.N

AC1= transform(adapt.cap.N, ADAPTIVE.CAP= (FISHERS.WELLN+ROTATION.N+MARKETN+TA.N)/4)

AC<- AC1[, c(1,3,8)]

## Normalization
ACN<- AC %>% 
  select(fishing.guild, ADAPT.MNGMT, ADAPTIVE.CAP)%>% 
  distinct%>%
  mutate (ADAPTIVE.CAPN=normalize_positive(ADAPTIVE.CAP))
        
AC<- ACN [, c(1, 2,4)]


```

## 3. Building Socio-ecological Vulnerability index
### 3.a Merging and generating new database

```{}
Dimension.matrixSE1<- merge(EV, SS, by="fishing.guild")
Dimension.matrixSE2<- merge(Dimension.matrixSE1, AC, by="fishing.guild")

#Creating a new dataframe
write.table(Dimension.matrixSE2, file="generated_dataframes/1704Socio_ecological_dimension.csv", sep = ";" )
````

### 3.b Import new database and calculate the dimension

```{}
dd <- read.csv("generated_dataframes/1704Socio_ecological_dimension.csv", sep = ";" )

#ECOLOGICAL VULNERABILITY SCORE
Socioeco.vul.index= transform(dd, SOCIOECO.VUL=(ECOLOGICAL.VULN+SENSITIVITYN)-ADAPTIVE.CAPN)

# Create a dataset with the final score
write.table(Socioeco.vul.index, file="generated_dataframes/1704SocioEcological_vulnerabilityAll.csv", sep = ";" )
Final.dataset<- read.csv("generated_dataframes/1704SocioEcological_vulnerabilityAll.csv", sep = ";" )

```

### 3.c Plot Ecological_vulnerability
```{}
#Create a categorical variable for exposure ("low","middle","high").
res <- Socioeco.vul.index %>% mutate(Ecological_Vulnerability=cut(ECOLOGICAL.VULN, breaks=c(-Inf, 0.333, 0.666, Inf), labels=c("low","middle","high")))

RES<- res %>% 
  select(fishing.guild, ECOLOGICAL.VULN, Modality, SENSITIVITYN, ADAPT.MNGMT, ADAPTIVE.CAPN, SOCIOECO.VUL, Ecological_Vulnerability)%>% 
  distinct%>%
  mutate (Social.Ecological_Vul=normalize_positive(SOCIOECO.VUL))

#Making the Plot
jpeg(file="figures/1704Socioecocological.vulnerability_dim2.jpeg", height=6, width= 8, units="in", res=300)
ggplot(RES, aes(x=ADAPTIVE.CAPN, y=SENSITIVITYN, size= Ecological_Vulnerability, color=Social.Ecological_Vul))+
  geom_point(alpha=0.3) +
  labs(x= "Adaptive Capacity", y= "Social Sensitivity", color="Social-ecological 
Vulnerability", size="Ecological 
Vulnerability")+
  xlim(-0.1, 1)+
  scale_size_discrete(range = c(4, 8)) +
  scale_colour_gradient2 (low="green", mid = "orange", high="red", midpoint = 0.5) +
  geom_text_repel(aes(label =fishing.guild), size=4.5) +
  theme_minimal(base_size = 13)
dev.off()

```

# Testing Adaptive Management effect

```{}
full.model<- lm(SOCIOECO.VUL~ADAPT.MNGMT, data = res)
summary(full.model)
anova(full.model)

## Plot
pred.df<- data.frame(ADAPT.MNGMT=c("market", "market&weather", "market&weather&stock", "weather", "None"))
pred.df$pred<-predict(full.model, newdata = pred.df)

res$names <- factor(res$ADAPT.MNGMT , levels=c("market", "market&weather", "market&weather&stock","weather", "None"))

jpeg(file="figures/Management-responses1704.jpeg", height=8, width= 10, units="in", res=300)
ppp<- plot(res$names, res$SOCIOECO.VUL, col=c("gray15", "gray28", "gray47", "gray60", "gray70"), xlab="Management Response", ylab= "Socioecological Vulnerability")
points(pred.df$pred, pch=19, cex=2, col= "darkgoldenrod")
legend("bottomright", legend= c("Mean"), pch=19, col=c("darkgoldenrod"))

nbGroup <- nlevels(res$names)
text( 
  x=c(1:nbGroup), 
  y=ppp$stats[nrow(ppp$stats),] + 0.02, 
  paste("n = ",table(res$names),sep="")  
)
dev.off()
```

# Testing Modality effect

```{}
full.model<- lm(SOCIOECO.VUL~Modality, data = res)
summary(full.model)
anova(full.model)

#Plot

pred.df<- data.frame(Modality=c("Boat", "Both", "Foot"))
pred.df$pred<-predict(full.model, newdata = pred.df)

jpeg(file="figures/Modality-effect1704.jpeg", height=6, width= 8, units="in", res=300)
mmm<- plot(res$Modality, res$SOCIOECO.VUL, col=c("gray15", "gray47", "gray70"), xlab="Modality", ylab= "Socioecological Vulnerability")
points(pred.df$pred, pch=19, cex=2, col= "darkgoldenrod")
legend("bottomright", legend= c("Mean"), pch=19, col=c("darkgoldenrod"))

nbGroup <- nlevels(res$Modality)
text( 
  x=c(1:nbGroup), 
  y=mmm$stats[nrow(mmm$stats),] + 0.02, 
  paste("n = ",table(res$Modality),sep="")  
)
dev.off()

```

# Ploting Adaptive Capacity effect to overcome SE-Vulnerability

```{}
AC.full<- lm(SOCIOECO.VUL~ADAPTIVE.CAPN, data = res)

#Create a function to call for summary and anova in a single step.

AC.lm.fullness<- function(model){
  a<- summary(model)
  b<- anova(model)
  print(a)
  print(b)
}

AC.lm.fullness(AC.full)  #There is a significant effect

jpeg(file="figures/AC-effect1704-2.jpeg", height=6, width= 8, units="in", res=300)
ggplot(res, aes(ADAPTIVE.CAPN, SOCIOECO.VUL)) +
  geom_point(col="gray47", pch=19, cex=2) +
  geom_abline(intercept= signif(AC.full$coef[[1]],5), slope= signif(AC.full$coef[[2]], 5), lwd= 1, col= "darkgoldenrod")+
  labs(title = paste("Adj R2 = ",signif(summary(AC.full)$adj.r.squared, 3)),
                      x= "Adaptive Capacity", y= "Social-ecological Vulnerability")+
  theme_classic(base_size = 13)
dev.off()




````


# Mapping Socioecological Vulnerability
To plot the Final Socioecoligical vulnerability index we need a SF file with the information of concellos delimitation. Our SF file use the "geometry" format. 

## Intalling packages and libraries
```{}
n


library(ggplot2)
library(RColorBrewer)
library(devtools)
library(sf)
library(tidyverse)
library(dplyr)

```

## Import Galcia map.sf file

```{}
# Read Galicia map database.sf file
Galicia_area <- sf::st_read("MAPAS/Concellos/Concellos_IGN.dbf", quiet = TRUE)
class(Galicia_area)

```

## Import Socio_ecological vulnerability Database
Note: The final socioecological vulnerability indez goes from -0.3 to 0.8. We are going to normalize the data between 0 an 1 to make map interpretation easier. 

```{}
Final_SE.V <- read.csv("MAPAS/to-map3.csv", sep = ";")

SEV<- Final_SE.V %>% 
  select(fishing.guild, Concello, SOCIOECOLOGICAL_VUL)%>% 
  distinct%>%
  mutate (SOCIOECOLOGICAL_VULN=normalize_positive(SOCIOECOLOGICAL_VUL))

# Merge databases
a <- merge(Galicia_area, SEV , by="Concello", all.x=TRUE)
```


## Map Plot
```{}
jpeg(file="figures/Map-socioeco.Vul.index1704.jpeg", height=8, width= 10, units="in", res=300)
a %>% 
  ggplot(cex.axis=1.5, cex.lab=1.5) +
  geom_sf(aes(fill = SOCIOECOLOGICAL_VULN, color="gray71"), show.legend = T, color="gray71")  +
  scale_fill_distiller(type = "seq", palette="Oranges",  direction = 1, limits=range(0, 1),  na.value = "gray71")+
  theme_bw()+
  labs(fill = "Social-ecological 
Vulnerability Index")
dev.off()
```

## FACTORS Rose Plot
```{}
# Adaptive Capacity Rose Plot
require(reshape2)
AC.plot<- AC1 [, c(-2, -3, -8)]
AC.plot2<- melt(AC.plot,id="fishing.guild")
jpeg(file="figures/rose.plot1704-2.jpeg", height=6, width= 8, units="in", res=300)
ggplot(data=AC.plot2,aes(x=fishing.guild, y=value, fill= variable))+
  geom_bar(stat="identity")+
  coord_polar()+
  guides(fill=guide_legend(title="Adaptive Capacity"))+
  scale_fill_brewer(palette="Dark2")+xlab("")+ylab("")+
  theme_minimal()
dev.off()

# Social Sensitivity Rose Plot
Sen.plot<- SENSITIVITY.factors  [, c(-2)]
Sen.plot2<- melt(Sen.plot,id="fishing.guild")
jpeg(file="figures/rose.plot.sensitiv1704.jpeg", height=6, width= 8, units="in", res=300)
ggplot(data=Sen.plot2,aes(x=fishing.guild, y=value, fill= variable))+
  geom_bar(stat="identity")+
  coord_polar()+
  guides(fill=guide_legend(title="Social Sensitivity"))+
  scale_fill_brewer(palette="Dark2")+xlab("")+ylab("") +
  theme_minimal()
dev.off()

```

install.packages("knitr")

install.packages('tinytex')
tinytex::install_tinytex()

